---
name: Create Version Bump PRs

on:
    # Triggered by pypi-release workflow after successful publish
    # Note: No branches filter - releases run on tags (e.g., v1.11.4), not branches
    workflow_run:
        workflows: [Publish all OpenHands packages (uv)]
        types: [completed]
    # Allow manual trigger with version input
    workflow_dispatch:
        inputs:
            version:
                description: Version to bump to (e.g., 1.11.3)
                required: true
                type: string

jobs:
    create-version-bump-prs:
        runs-on: ubuntu-24.04
        # Only run on successful workflow_run or manual dispatch
        if: >
            github.event_name == 'workflow_dispatch' ||
            (github.event.workflow_run.conclusion == 'success' &&
             github.event.workflow_run.event == 'release')
        env:
            GH_TOKEN: ${{ secrets.ALLHANDS_BOT_GITHUB_PAT }}
        steps:
            - name: Checkout
              uses: actions/checkout@v5

            - name: Get version from release or input
              id: get_version
              run: |
                  if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                    VERSION="${{ github.event.inputs.version }}"
                  else
                    # Get version from the release that triggered the workflow_run
                    # The workflow_run was triggered by a release event
                    RELEASE_TAG=$(gh api repos/${{ github.repository }}/releases/latest --jq '.tag_name')
                    VERSION="${RELEASE_TAG#v}"  # Remove 'v' prefix
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "üì¶ Version: $VERSION"

            - name: Validate version
              env:
                  VERSION: ${{ steps.get_version.outputs.version }}
              run: |
                  if [ -z "$VERSION" ]; then
                    echo "‚ùå Version is empty"
                    exit 1
                  fi
                  echo "üì¶ Creating version bump PRs for version: $VERSION"

            - name: Wait for packages to be available on PyPI
              env:
                  VERSION: ${{ steps.get_version.outputs.version }}
              run: |
                  set -euo pipefail

                  PACKAGES=(
                    openhands-sdk
                    openhands-tools
                    openhands-workspace
                    openhands-agent-server
                  )

                  MAX_ATTEMPTS=60
                  SLEEP_SECONDS=20

                  echo "‚è≥ Waiting for packages to be available on PyPI..."

                  for PKG in "${PACKAGES[@]}"; do
                    echo "Checking $PKG==$VERSION..."
                    ATTEMPT=1
                    while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
                      # Check if the package version is available on PyPI
                      HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                        "https://pypi.org/pypi/$PKG/$VERSION/json")

                      if [ "$HTTP_CODE" = "200" ]; then
                        echo "‚úÖ $PKG==$VERSION is available on PyPI"
                        break
                      fi

                      echo "  Attempt $ATTEMPT/$MAX_ATTEMPTS: $PKG==$VERSION not yet available (HTTP $HTTP_CODE), waiting ${SLEEP_SECONDS}s..."
                      sleep $SLEEP_SECONDS
                      ATTEMPT=$((ATTEMPT + 1))
                    done

                    if [ $ATTEMPT -gt $MAX_ATTEMPTS ]; then
                      echo "‚ùå Timeout waiting for $PKG==$VERSION to be available on PyPI"
                      exit 1
                    fi
                  done

                  echo "‚úÖ All packages are available on PyPI!"

            - name: Install uv
              uses: astral-sh/setup-uv@v7
              with:
                  version: latest
                  python-version: '3.12'

            - name: Install Poetry
              run: |
                  pipx install poetry

            # OpenHands-CLI step runs first since it's simpler and less error-prone
            - name: Create PR for OpenHands-CLI repo
              env:
                  VERSION: ${{ steps.get_version.outputs.version }}
              run: |
                  set -euo pipefail

                  REPO="OpenHands/openhands-cli"
                  BRANCH="bump-sdk-$VERSION"

                  echo "üîÑ Creating PR for $REPO..."

                  # Clone the repo
                  git clone "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git" openhands-cli-repo
                  cd openhands-cli-repo

                  # Configure git
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  # Check if branch already exists on remote
                  if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
                    echo "‚ö†Ô∏è Branch $BRANCH already exists, checking out existing branch"
                    git fetch origin "$BRANCH"
                    git checkout "$BRANCH"
                  else
                    # Create branch
                    git checkout -b "$BRANCH"
                  fi

                  # Update versions using uv (--refresh to bypass cache and get fresh PyPI data)
                  uv add --refresh "openhands-sdk==$VERSION" "openhands-tools==$VERSION"

                  # Check if there are changes
                  if git diff --quiet; then
                    echo "‚ö†Ô∏è No changes detected in $REPO - versions may already be up to date"
                    exit 0
                  fi

                  # Commit and push
                  git add pyproject.toml uv.lock
                  git commit -m "Bump openhands-sdk, openhands-tools to $VERSION" \
                    -m "Automated version bump after PyPI release." \
                    -m "Co-authored-by: openhands <openhands@all-hands.dev>"
                  git push -u origin "$BRANCH"

                  # Check if PR already exists
                  EXISTING_PR=$(gh pr list --repo "$REPO" --head "$BRANCH" --json number --jq '.[0].number')
                  if [ -n "$EXISTING_PR" ]; then
                    echo "‚úÖ PR #$EXISTING_PR already exists for $REPO"
                  else
                    # Create PR
                    gh pr create \
                      --repo "$REPO" \
                      --title "Bump SDK packages to v$VERSION" \
                      --body "## Automated Version Bump

                  This PR updates the following packages to version **$VERSION**:
                  - \`openhands-sdk\`
                  - \`openhands-tools\`

                  **Triggered by:** Release of [software-agent-sdk v$VERSION](https://github.com/OpenHands/software-agent-sdk/releases/tag/v$VERSION)

                  ---
                  _This PR was automatically created by the version-bump-prs workflow._" \
                      --base main \
                      --head "$BRANCH"

                    echo "‚úÖ PR created for $REPO"
                  fi

            - name: Create PR for OpenHands repo
              env:
                  VERSION: ${{ steps.get_version.outputs.version }}
              run: |
                  set -euo pipefail

                  REPO="All-Hands-AI/OpenHands"
                  BRANCH="bump-sdk-$VERSION"

                  echo "üîÑ Creating PR for $REPO..."

                  # Clone the repo
                  git clone "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git" openhands-repo
                  cd openhands-repo

                  # Configure git
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  # Check if branch already exists on remote
                  if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
                    echo "‚ö†Ô∏è Branch $BRANCH already exists, checking out existing branch"
                    git fetch origin "$BRANCH"
                    git checkout "$BRANCH"
                  else
                    # Create branch
                    git checkout -b "$BRANCH"
                  fi

                  # Get the git hash from the release branch in software-agent-sdk
                  SDK_COMMIT_HASH=$(git ls-remote https://github.com/OpenHands/software-agent-sdk.git "refs/tags/v$VERSION" | cut -c1-7)
                  if [ -z "$SDK_COMMIT_HASH" ]; then
                    echo "‚ö†Ô∏è Could not find commit hash for tag v$VERSION, using full version"
                    SDK_COMMIT_HASH="$VERSION"
                  fi
                  echo "üì¶ SDK commit hash: $SDK_COMMIT_HASH"

                  # 1. Update versions in pyproject.toml and poetry.lock using poetry (root)
                  # The --lock flag updates both pyproject.toml AND poetry.lock
                  # Note: enterprise/pyproject.toml gets these dependencies transitively via openhands-ai
                  echo "üìù Updating root pyproject.toml and poetry.lock..."

                  # Verify enterprise/pyproject.toml does NOT have SDK packages explicitly listed
                  # If they exist there, they will become stale since we only update root pyproject.toml
                  if [ -f "enterprise/pyproject.toml" ]; then
                    echo "üîç Verifying enterprise/pyproject.toml doesn't have explicit SDK packages..."
                    SDK_PACKAGES=("openhands-sdk" "openhands-tools" "openhands-agent-server")
                    for pkg in "${SDK_PACKAGES[@]}"; do
                      # Match package name as a TOML key (with optional leading whitespace) followed by =
                      # This catches both 'openhands-sdk = "1.2.3"' and 'openhands-sdk="1.2.3"'
                      if grep -qE "^[[:space:]]*${pkg}[[:space:]]*=" enterprise/pyproject.toml; then
                        echo "‚ùå ERROR: enterprise/pyproject.toml contains explicit reference to '$pkg'"
                        echo "   These packages should come transitively via openhands-ai dependency."
                        echo "   Please remove '$pkg' from enterprise/pyproject.toml to avoid version drift."
                        exit 1
                      fi
                    done
                    echo "‚úÖ enterprise/pyproject.toml does not have explicit SDK packages"
                  fi

                  poetry add --lock "openhands-sdk==$VERSION" "openhands-tools==$VERSION" "openhands-agent-server==$VERSION"

                  # 2. Update the hash in sandbox_spec_service.py
                  echo "üîß Updating AGENT_SERVER_IMAGE hash..."
                  SANDBOX_SPEC_FILE="openhands/app_server/sandbox/sandbox_spec_service.py"
                  if [ -f "$SANDBOX_SPEC_FILE" ]; then
                    # Update the AGENT_SERVER_IMAGE line with the new hash
                    sed -i "s|AGENT_SERVER_IMAGE = 'ghcr.io/openhands/agent-server:[^']*'|AGENT_SERVER_IMAGE = 'ghcr.io/openhands/agent-server:${SDK_COMMIT_HASH}-python'|" "$SANDBOX_SPEC_FILE"
                    echo "‚úÖ Updated AGENT_SERVER_IMAGE to: ghcr.io/openhands/agent-server:${SDK_COMMIT_HASH}-python"
                  else
                    echo "‚ùå sandbox_spec_service.py not found at expected path"
                    exit 1
                  fi

                  # 3. Run pre-commit to fix formatting (pyproject-fmt removes parentheses from version specs)
                  echo "üîß Running pre-commit to fix formatting..."
                  pip install pre-commit
                  pre-commit run --files pyproject.toml --config ./dev_config/python/.pre-commit-config.yaml || true

                  # Check if there are changes
                  if git diff --quiet; then
                    echo "‚ö†Ô∏è No changes detected in $REPO - versions may already be up to date"
                    exit 0
                  fi

                  # Commit and push
                  git add .
                  git commit -m "Bump openhands-sdk, openhands-tools, openhands-agent-server to $VERSION" \
                    -m "Automated version bump after PyPI release." \
                    -m "" \
                    -m "Changes:" \
                    -m "- Updated SDK packages to v$VERSION in pyproject.toml" \
                    -m "- Regenerated poetry.lock" \
                    -m "- Updated AGENT_SERVER_IMAGE hash to ${SDK_COMMIT_HASH}" \
                    -m "" \
                    -m "Co-authored-by: openhands <openhands@all-hands.dev>"
                  git push -u origin "$BRANCH"

                  # Check if PR already exists
                  EXISTING_PR=$(gh pr list --repo "$REPO" --head "$BRANCH" --json number --jq '.[0].number')
                  if [ -n "$EXISTING_PR" ]; then
                    echo "‚úÖ PR #$EXISTING_PR already exists for $REPO"
                  else
                    # Create PR
                    gh pr create \
                      --repo "$REPO" \
                      --title "Bump SDK packages to v$VERSION" \
                      --body "## Automated Version Bump

                  This PR updates the following packages to version **$VERSION**:
                  - \`openhands-sdk\`
                  - \`openhands-tools\`
                  - \`openhands-agent-server\`

                  ### Changes
                  - Updated SDK packages in \`pyproject.toml\`
                  - Regenerated \`poetry.lock\`
                  - Updated \`AGENT_SERVER_IMAGE\` hash to \`${SDK_COMMIT_HASH}\` in \`sandbox_spec_service.py\`

                  **Triggered by:** Release of [software-agent-sdk v$VERSION](https://github.com/OpenHands/software-agent-sdk/releases/tag/v$VERSION)

                  ---
                  _This PR was automatically created by the version-bump-prs workflow._" \
                      --base main \
                      --head "$BRANCH"

                    echo "‚úÖ PR created for $REPO"
                  fi

            - name: Summary
              env:
                  VERSION: ${{ steps.get_version.outputs.version }}
              run: |
                  echo "## ‚úÖ Version Bump PRs Created" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "PRs have been created to bump SDK packages to version **$VERSION**:" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- [OpenHands](https://github.com/All-Hands-AI/OpenHands/pulls?q=is%3Apr+bump-sdk-$VERSION)" >> $GITHUB_STEP_SUMMARY
                  echo "- [OpenHands-CLI](https://github.com/OpenHands/openhands-cli/pulls?q=is%3Apr+bump-sdk-$VERSION)" >> $GITHUB_STEP_SUMMARY

            - name: Notify Slack
              uses: slackapi/slack-github-action@v2.1.1
              with:
                  method: chat.postMessage
                  token: ${{ secrets.SLACK_BOT_TOKEN }}
                  payload: |
                      channel: C08E1SYKEM9
                      text: "üöÄ *SDK v${{ steps.get_version.outputs.version }} published to PyPI!*\n\nVersion bump PRs created:\n‚Ä¢ <https://github.com/All-Hands-AI/OpenHands/pulls?q=is%3Apr+bump-sdk-${{ steps.get_version.outputs.version }}|OpenHands>\n‚Ä¢ <https://github.com/OpenHands/openhands-cli/pulls?q=is%3Apr+bump-sdk-${{ steps.get_version.outputs.version }}|OpenHands-CLI>\n\n<https://github.com/OpenHands/software-agent-sdk/releases/tag/v${{ steps.get_version.outputs.version }}|View Release>"
